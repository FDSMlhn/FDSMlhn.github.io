<!DOCTYPE html>












  


<html class="theme-next mist use-motion" lang="zh-CN">
<head><meta name="generator" content="Hexo 3.8.0">
  <!-- hexo-inject:begin --><!-- hexo-inject:end --><meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
























<link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css?v=4.7.0">

<link rel="stylesheet" href="/css/main.css?v=7.1.2">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=7.1.2">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=7.1.2">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=7.1.2">


  <link rel="mask-icon" href="/images/logo.svg?v=7.1.2" color="#222">







<script id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Mist',
    version: '7.1.2',
    sidebar: {"position":"left","display":"post","offset":12,"onmobile":false,"dimmer":false},
    back2top: true,
    back2top_sidebar: false,
    fancybox: false,
    fastclick: false,
    lazyload: false,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>


  




  <meta name="description" content="Background While I interned at my current company - Kuaishou, I was in part of the project where I need to set up a LSTM model, and I have to transfer my skill sets to Tensorflow from Pytorch in a sh">
<meta name="keywords" content="Machine Learning; Coding; 旅行见闻！">
<meta property="og:type" content="article">
<meta property="og:title" content="Advanced Tensorflow Usage and Experiment: from input_fn to modelling part">
<meta property="og:url" content="http://fdsmlhn.github.io/2018/08/12/Advanced-Tensorflow-Usage-and-Experiment-from-input-fn-to-modelling-part/index.html">
<meta property="og:site_name" content="Nevermore">
<meta property="og:description" content="Background While I interned at my current company - Kuaishou, I was in part of the project where I need to set up a LSTM model, and I have to transfer my skill sets to Tensorflow from Pytorch in a sh">
<meta property="og:locale" content="zh-CN">
<meta property="og:updated_time" content="2018-08-12T12:42:12.697Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Advanced Tensorflow Usage and Experiment: from input_fn to modelling part">
<meta name="twitter:description" content="Background While I interned at my current company - Kuaishou, I was in part of the project where I need to set up a LSTM model, and I have to transfer my skill sets to Tensorflow from Pytorch in a sh">





  
  
  <link rel="canonical" href="http://fdsmlhn.github.io/2018/08/12/Advanced-Tensorflow-Usage-and-Experiment-from-input-fn-to-modelling-part/">



<script id="page.configurations">
  CONFIG.page = {
    sidebar: "",
  };
</script>

  <title>Advanced Tensorflow Usage and Experiment: from input_fn to modelling part | Nevermore</title>
  












  <noscript>
  <style>
  .use-motion .motion-element,
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-title { opacity: initial; }

  .use-motion .logo,
  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript><!-- hexo-inject:begin --><!-- hexo-inject:end -->

<link rel="stylesheet" href="/css/prism-tomorrow.css" type="text/css"></head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-CN">

  
  
    
  

  <!-- hexo-inject:begin --><!-- hexo-inject:end --><div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Nevermore</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
    
      
        <p class="site-subtitle">Just begins.</p>
      
    
    
  </div>

  <div class="site-nav-toggle">
    <button aria-label="切换导航栏">
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>



<nav class="site-nav">
  
    <ul id="menu" class="menu">
      
        
        
        
          
          <li class="menu-item menu-item-home">

    
    
    
      
    

    

    <a href="/" rel="section"><i class="menu-item-icon fa fa-fw fa-home"></i> <br>首页</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-about">

    
    
    
      
    

    

    <a href="/about/" rel="section"><i class="menu-item-icon fa fa-fw fa-user"></i> <br>关于</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-archives">

    
    
    
      
    

    

    <a href="/archives/" rel="section"><i class="menu-item-icon fa fa-fw fa-archive"></i> <br>归档</a>

  </li>

      
      
    </ul>
  

  
    

  

  
</nav>



  



</div>
    </header>

    


    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://fdsmlhn.github.io/2018/08/12/Advanced-Tensorflow-Usage-and-Experiment-from-input-fn-to-modelling-part/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Haonan Li">
      <meta itemprop="description" content="Strong Mind = Success">
      <meta itemprop="image" content="/images/selfie1.JPG">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Nevermore">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">Advanced Tensorflow Usage and Experiment: from input_fn to modelling part

              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2018-08-12 20:33:44 / 修改时间：05:42:12" itemprop="dateCreated datePublished" datetime="2018-08-12T20:33:44-07:00">2018-08-12</time>
            

            
              

              
            
          </span>

          

          
            
            
              
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
            
                <span class="post-meta-item-text">评论数：</span>
                <a href="/2018/08/12/Advanced-Tensorflow-Usage-and-Experiment-from-input-fn-to-modelling-part/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2018/08/12/Advanced-Tensorflow-Usage-and-Experiment-from-input-fn-to-modelling-part/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          
            <span id="/2018/08/12/Advanced-Tensorflow-Usage-and-Experiment-from-input-fn-to-modelling-part/" class="leancloud_visitors" data-flag-title="Advanced Tensorflow Usage and Experiment: from input_fn to modelling part">
              <span class="post-meta-divider">|</span>
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              
                <span class="post-meta-item-text">阅读次数：</span>
              
                <span class="leancloud-visitors-count"></span>
            </span>
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <hr>
<h2 id="background">Background</h2>
<p>While I interned at my current company - Kuaishou, I was in part of the project where I need to set up a LSTM model, and I have to transfer my skill sets to Tensorflow from Pytorch in a short period of time , which was really painful experience for me. So I want to share this blog with you to ease your pain. <a id="more"></a></p>
<h2 id="some-complaints">Some complaints</h2>
<p>Although I have to admit Tensorflow is a very powerful computing framework: it has much stronger and larger community to support it compared with Pytorch; it allows you to get accees to some fancy, high-level attributes like tf.serving, tensorboard, distributed computation, etc, it has very steep learning curve and be super extra unfriendly to new users because of its rapid shift of version. Maybe you are first struggled with tf.placeholder version of data preprocessing and modelling and suddenly you find out it's not how we use it anymore, how would you feel then? Well, if it's the first blog you see, you know what i mean in a few hours...</p>
<h2 id="whats-exactly-in-this-blog">What's exactly in this blog</h2>
<p>In this blog I present most of experiments I did while writing the LSTM model code with Tensorflow version 1.9 and Python 3.6. I split my toy experiments into 4 parts:</p>
<ul>
<li>data input process</li>
<li>LSTM cell test</li>
<li>Shared embedding test</li>
<li>Miscellany function</li>
</ul>
<h2 id="who-should-read-this-blog">Who should read this blog</h2>
<p>You should already get some taste of the tensorflow and want to know more detailed and useful knowledge without writing these toy examples yourself. I'm very confident these functions or tests will be helpful if you are dealing with high volumn of data and want to format your code neatly.</p>
<h1 id="data-input-process">data input process</h1>
<h2 id="tfrecord-saving-reading">tfrecord saving, reading</h2>
<div class="sourceCode" id="cb1"><pre class="sourceCode python"><code class="sourceCode python"><a class="sourceLine" id="cb1-1" data-line-number="1"><span class="im">import</span> tensorflow <span class="im">as</span> tf </a>
<a class="sourceLine" id="cb1-2" data-line-number="2"><span class="im">import</span> numpy <span class="im">as</span> np</a>
<a class="sourceLine" id="cb1-3" data-line-number="3"></a>
<a class="sourceLine" id="cb1-4" data-line-number="4"><span class="kw">def</span> writedata():</a>
<a class="sourceLine" id="cb1-5" data-line-number="5">xlist <span class="op">=</span> [[<span class="dv">1</span>,<span class="dv">2</span>,<span class="dv">3</span>],[<span class="dv">4</span>,<span class="dv">5</span>,<span class="dv">6</span>,<span class="dv">8</span>],[<span class="dv">23</span>,<span class="dv">1</span>]]</a>
<a class="sourceLine" id="cb1-6" data-line-number="6">xstar_list <span class="op">=</span> [[<span class="dv">15</span>, <span class="dv">25</span>],[<span class="fl">23.1</span>],[<span class="dv">1</span>,<span class="dv">2</span>,<span class="dv">3</span>]]</a>
<a class="sourceLine" id="cb1-7" data-line-number="7">ylist <span class="op">=</span> [<span class="dv">1</span>,<span class="dv">2</span>,<span class="dv">3</span>]</a>
<a class="sourceLine" id="cb1-8" data-line-number="8"><span class="co">#name_list = [[&#39;a&#39;.encode(&#39;utf8&#39;), &#39;b&#39;.encode(&#39;utf8&#39;)], [&#39;a&#39;.encode(&#39;utf8&#39;), &#39;c&#39;.encode(&#39;utf8&#39;), &#39;d&#39;.encode(&#39;utf8&#39;)]]</span></a>
<a class="sourceLine" id="cb1-9" data-line-number="9">name_list <span class="op">=</span> [[<span class="st">&#39;a&#39;</span>.encode(<span class="st">&#39;utf8&#39;</span>), <span class="st">&#39;b&#39;</span>.encode(<span class="st">&#39;utf8&#39;</span>)], [<span class="st">&#39;a&#39;</span>.encode(<span class="st">&#39;utf8&#39;</span>)],[<span class="st">&#39;b&#39;</span>.encode(<span class="st">&#39;utf8&#39;</span>)]]</a>
<a class="sourceLine" id="cb1-10" data-line-number="10"></a>
<a class="sourceLine" id="cb1-11" data-line-number="11">writer <span class="op">=</span> tf.python_io.TFRecordWriter(<span class="st">&quot;train.tfrecords&quot;</span>)</a>
<a class="sourceLine" id="cb1-12" data-line-number="12"><span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">3</span>):</a>
<a class="sourceLine" id="cb1-13" data-line-number="13">x <span class="op">=</span> xlist[i]</a>
<a class="sourceLine" id="cb1-14" data-line-number="14">y <span class="op">=</span> ylist[i]</a>
<a class="sourceLine" id="cb1-15" data-line-number="15">x_star <span class="op">=</span> xstar_list[i]</a>
<a class="sourceLine" id="cb1-16" data-line-number="16">name <span class="op">=</span> name_list[i]</a>
<a class="sourceLine" id="cb1-17" data-line-number="17">example <span class="op">=</span> tf.train.Example(features<span class="op">=</span>tf.train.Features(feature<span class="op">=</span>{</a>
<a class="sourceLine" id="cb1-18" data-line-number="18"><span class="st">&quot;y&quot;</span>: tf.train.Feature(int64_list<span class="op">=</span>tf.train.Int64List(value<span class="op">=</span>[y])),</a>
<a class="sourceLine" id="cb1-19" data-line-number="19"><span class="st">&#39;x&#39;</span>: tf.train.Feature(int64_list<span class="op">=</span>tf.train.Int64List(value<span class="op">=</span>x)),</a>
<a class="sourceLine" id="cb1-20" data-line-number="20"><span class="st">&#39;x_star&#39;</span>: tf.train.Feature(float_list<span class="op">=</span>tf.train.FloatList(value<span class="op">=</span>x_star)),</a>
<a class="sourceLine" id="cb1-21" data-line-number="21"><span class="st">&#39;name_star&#39;</span>:tf.train.Feature(bytes_list<span class="op">=</span> tf.train.BytesList(value<span class="op">=</span> name))</a>
<a class="sourceLine" id="cb1-22" data-line-number="22"></a>
<a class="sourceLine" id="cb1-23" data-line-number="23">}))</a>
<a class="sourceLine" id="cb1-24" data-line-number="24">writer.write(example.SerializeToString())</a>
<a class="sourceLine" id="cb1-25" data-line-number="25">writer.close()</a>
<a class="sourceLine" id="cb1-26" data-line-number="26"></a>
<a class="sourceLine" id="cb1-27" data-line-number="27">writedata()</a></code></pre></div>
<h2 id="experiment">Experiment</h2>
<ol type="1">
<li>sparse tensor can be used in embedding layer directly，it will ignore default value and also won't be count into denominator when the <code>combiner</code> is mean</li>
<li>sparse_tensor_to_dense must have corresponding type of default_value to it's own data type ，like int,float can use 0 as default value, while tf.string has to be str,e.g. '0'.</li>
<li>If you use tf.dataset.batch, and have various length data, then you should use parse_example instead of parse_single_example</li>
<li>tf.pad can also pad outer dimension, which means increase a layer of zero outside your data</li>
</ol>
<div class="sourceCode" id="cb2"><pre class="sourceCode python"><code class="sourceCode python"><a class="sourceLine" id="cb2-1" data-line-number="1"><span class="im">import</span> tensorflow <span class="im">as</span> tf </a>
<a class="sourceLine" id="cb2-2" data-line-number="2"><span class="im">import</span> numpy <span class="im">as</span> np</a>
<a class="sourceLine" id="cb2-3" data-line-number="3"></a>
<a class="sourceLine" id="cb2-4" data-line-number="4"></a>
<a class="sourceLine" id="cb2-5" data-line-number="5"><span class="kw">def</span> my_input_fn(file_path, perform_shuffle<span class="op">=</span><span class="va">False</span>, repeat_count<span class="op">=</span><span class="dv">10</span>):</a>
<a class="sourceLine" id="cb2-6" data-line-number="6"><span class="kw">def</span> parse(example_proto):</a>
<a class="sourceLine" id="cb2-7" data-line-number="7">features <span class="op">=</span> {<span class="st">&quot;x&quot;</span>: tf.VarLenFeature(tf.int64),</a>
<a class="sourceLine" id="cb2-8" data-line-number="8"><span class="st">&quot;x_star&quot;</span>: tf.VarLenFeature(tf.float32),</a>
<a class="sourceLine" id="cb2-9" data-line-number="9"><span class="st">&#39;name_star&#39;</span>:tf.VarLenFeature(tf.string),</a>
<a class="sourceLine" id="cb2-10" data-line-number="10"><span class="st">&quot;y&quot;</span>: tf.FixedLenFeature([<span class="dv">1</span>], tf.int64)}</a>
<a class="sourceLine" id="cb2-11" data-line-number="11">parsed_features <span class="op">=</span> tf.parse_example(example_proto, features)</a>
<a class="sourceLine" id="cb2-12" data-line-number="12">x <span class="op">=</span> tf.sparse_tensor_to_dense(parsed_features[<span class="st">&quot;x&quot;</span>])</a>
<a class="sourceLine" id="cb2-13" data-line-number="13">x <span class="op">=</span> tf.cast(x, tf.int32)</a>
<a class="sourceLine" id="cb2-14" data-line-number="14"></a>
<a class="sourceLine" id="cb2-15" data-line-number="15">parsed_features[<span class="st">&#39;x&#39;</span>] <span class="op">=</span> x</a>
<a class="sourceLine" id="cb2-16" data-line-number="16">parsed_features[<span class="st">&#39;x_star&#39;</span>] <span class="op">=</span> tf.sparse_tensor_to_dense(parsed_features[<span class="st">&quot;x_star&quot;</span>])</a>
<a class="sourceLine" id="cb2-17" data-line-number="17">parsed_features[<span class="st">&#39;name_star&#39;</span>] <span class="op">=</span> tf.sparse_tensor_to_dense(parsed_features[<span class="st">&quot;name_star&quot;</span>], default_value<span class="op">=</span> <span class="st">&#39;0&#39;</span>)</a>
<a class="sourceLine" id="cb2-18" data-line-number="18"></a>
<a class="sourceLine" id="cb2-19" data-line-number="19">y <span class="op">=</span> tf.cast(parsed_features[<span class="st">&quot;y&quot;</span>], tf.int32)</a>
<a class="sourceLine" id="cb2-20" data-line-number="20"><span class="cf">return</span> parsed_features, y</a>
<a class="sourceLine" id="cb2-21" data-line-number="21"></a>
<a class="sourceLine" id="cb2-22" data-line-number="22"></a>
<a class="sourceLine" id="cb2-23" data-line-number="23">dataset <span class="op">=</span> tf.data.TFRecordDataset(file_path).batch(<span class="dv">3</span>)</a>
<a class="sourceLine" id="cb2-24" data-line-number="24">dataset<span class="op">=</span> dataset.<span class="bu">map</span>(parse)</a>
<a class="sourceLine" id="cb2-25" data-line-number="25"></a>
<a class="sourceLine" id="cb2-26" data-line-number="26"><span class="co">#dataset = (tf.data.TFRecordDataset(file_path).batch(2).map(parse))</span></a>
<a class="sourceLine" id="cb2-27" data-line-number="27"><span class="cf">if</span> perform_shuffle:</a>
<a class="sourceLine" id="cb2-28" data-line-number="28">dataset <span class="op">=</span> dataset.shuffle(buffer_size<span class="op">=</span><span class="dv">256</span>)</a>
<a class="sourceLine" id="cb2-29" data-line-number="29">dataset <span class="op">=</span> dataset.repeat(repeat_count)</a>
<a class="sourceLine" id="cb2-30" data-line-number="30"><span class="co">#dataset = dataset.padded_batch(2, padded_shapes=({&#39;x&#39;:[6]},[1]))  #batch size为2，并且x按maxlen=6来做padding</span></a>
<a class="sourceLine" id="cb2-31" data-line-number="31"><span class="co">#dataset = dataset.padded_batch(2, padded_shapes=dataset.output_shapes)  #batch size为2，并且x按maxlen=6来做padding</span></a>
<a class="sourceLine" id="cb2-32" data-line-number="32"></a>
<a class="sourceLine" id="cb2-33" data-line-number="33">iterator <span class="op">=</span> dataset.make_one_shot_iterator()</a>
<a class="sourceLine" id="cb2-34" data-line-number="34">batch_features, batch_labels <span class="op">=</span> iterator.get_next()</a>
<a class="sourceLine" id="cb2-35" data-line-number="35"><span class="cf">return</span> batch_features, batch_labels</a>
<a class="sourceLine" id="cb2-36" data-line-number="36"></a>
<a class="sourceLine" id="cb2-37" data-line-number="37">next_batch <span class="op">=</span> my_input_fn(<span class="st">&#39;train.tfrecords&#39;</span>, <span class="va">True</span>)</a>
<a class="sourceLine" id="cb2-38" data-line-number="38"></a>
<a class="sourceLine" id="cb2-39" data-line-number="39"></a>
<a class="sourceLine" id="cb2-40" data-line-number="40"><span class="co">##test embedding </span></a>
<a class="sourceLine" id="cb2-41" data-line-number="41">feat_columns <span class="op">=</span> []       <span class="co">#feat_columns must be iterable datatype </span></a>
<a class="sourceLine" id="cb2-42" data-line-number="42">feat_columns.append(tf.feature_column.numeric_column(<span class="st">&#39;x&#39;</span>, <span class="dv">4</span>))       <span class="co">#0</span></a>
<a class="sourceLine" id="cb2-43" data-line-number="43">feat_columns.append(tf.feature_column.numeric_column(<span class="st">&#39;x_star&#39;</span>,<span class="dv">2</span>))   <span class="co">#1</span></a>
<a class="sourceLine" id="cb2-44" data-line-number="44"></a>
<a class="sourceLine" id="cb2-45" data-line-number="45"></a>
<a class="sourceLine" id="cb2-46" data-line-number="46">embed_info <span class="op">=</span> tf.feature_column.categorical_column_with_vocabulary_list(</a>
<a class="sourceLine" id="cb2-47" data-line-number="47"><span class="st">&#39;name_star&#39;</span>,</a>
<a class="sourceLine" id="cb2-48" data-line-number="48">[<span class="st">&#39;a&#39;</span>,<span class="st">&#39;b&#39;</span>,<span class="st">&#39;c&#39;</span>,<span class="st">&#39;d&#39;</span>,<span class="st">&#39;e&#39;</span>], default_value<span class="op">=-</span><span class="dv">1</span>,</a>
<a class="sourceLine" id="cb2-49" data-line-number="49">dtype<span class="op">=</span>tf.string, num_oov_buckets<span class="op">=</span><span class="dv">2</span>)</a>
<a class="sourceLine" id="cb2-50" data-line-number="50"></a>
<a class="sourceLine" id="cb2-51" data-line-number="51">name_tensor<span class="op">=</span> tf.feature_column.embedding_column(embed_info, <span class="dv">5</span>, combiner<span class="op">=</span><span class="st">&#39;mean&#39;</span>)</a>
<a class="sourceLine" id="cb2-52" data-line-number="52"></a>
<a class="sourceLine" id="cb2-53" data-line-number="53"><span class="co">#feat_columns.append(tf.feature_column.shared_embedding_columns([embed_info], dimension =32)[0])</span></a>
<a class="sourceLine" id="cb2-54" data-line-number="54"><span class="co">#feat_columns.append(tf.feature_column.embedding_column(embed_info, dimension =32))      #2</span></a></code></pre></div>
<div class="sourceCode" id="cb3"><pre class="sourceCode python"><code class="sourceCode python"><a class="sourceLine" id="cb3-1" data-line-number="1">op<span class="op">=</span>tf.feature_column.input_layer(next_batch[<span class="dv">0</span>],feature_columns<span class="op">=</span>name_tensor)</a>
<a class="sourceLine" id="cb3-2" data-line-number="2"><span class="cf">with</span> tf.Session() <span class="im">as</span> sess:</a>
<a class="sourceLine" id="cb3-3" data-line-number="3"><span class="co">#sess.run(init)</span></a>
<a class="sourceLine" id="cb3-4" data-line-number="4">sess.run(tf.global_variables_initializer())</a>
<a class="sourceLine" id="cb3-5" data-line-number="5">sess.run(tf.tables_initializer())</a>
<a class="sourceLine" id="cb3-6" data-line-number="6"><span class="bu">print</span>(sess.run([op]))</a>
<a class="sourceLine" id="cb3-7" data-line-number="7"></a>
<a class="sourceLine" id="cb3-8" data-line-number="8">sess.run(tf.global_variables_initializer())</a>
<a class="sourceLine" id="cb3-9" data-line-number="9">xs, y <span class="op">=</span>sess.run(next_batch)        </a>
<a class="sourceLine" id="cb3-10" data-line-number="10"><span class="co">#print(sess.run([tf.feature_column.input_layer(xs,feature_columns=[name_tensor])]))</span></a>
<a class="sourceLine" id="cb3-11" data-line-number="11"><span class="bu">print</span>(np.size(xs[<span class="st">&#39;x&#39;</span>])) <span class="co"># 2*4  batch_size 2</span></a>
<a class="sourceLine" id="cb3-12" data-line-number="12"><span class="bu">print</span>(<span class="st">&#39;x: &#39;</span>, xs[<span class="st">&#39;x&#39;</span>])</a>
<a class="sourceLine" id="cb3-13" data-line-number="13"><span class="bu">print</span>(<span class="st">&#39;x_star: &#39;</span>, xs[<span class="st">&#39;x_star&#39;</span>])</a>
<a class="sourceLine" id="cb3-14" data-line-number="14"><span class="bu">print</span>(<span class="st">&#39;y:&#39;</span>, y)</a>
<a class="sourceLine" id="cb3-15" data-line-number="15"></a>
<a class="sourceLine" id="cb3-16" data-line-number="16"><span class="bu">print</span>(<span class="st">&#39;testing pad for lstm&#39;</span>)</a>
<a class="sourceLine" id="cb3-17" data-line-number="17"><span class="co">#print(sess.run(tf.pad(xs[&#39;x&#39;],tf.constant([[0,0],[0,0]], dtype=tf.int32))))</span></a>
<a class="sourceLine" id="cb3-18" data-line-number="18"></a>
<a class="sourceLine" id="cb3-19" data-line-number="19"><span class="bu">print</span>(<span class="st">&#39;testing feature columns for lstm&#39;</span>)</a>
<a class="sourceLine" id="cb3-20" data-line-number="20"><span class="co">#print(sess.run(tf.feature_column.input_layer(xs,feature_columns=feat_columns[0])))</span></a>
<a class="sourceLine" id="cb3-21" data-line-number="21"></a>
<a class="sourceLine" id="cb3-22" data-line-number="22"><span class="bu">print</span>(<span class="st">&#39;testing string feature columns&#39;</span>)</a>
<a class="sourceLine" id="cb3-23" data-line-number="23"><span class="bu">print</span>(xs[<span class="st">&#39;name_star&#39;</span>])</a>
<a class="sourceLine" id="cb3-24" data-line-number="24"><span class="co">#print(feat_columns[2])</span></a>
<a class="sourceLine" id="cb3-25" data-line-number="25"><span class="co">#print(sess.run([op]))</span></a>
<a class="sourceLine" id="cb3-26" data-line-number="26"></a>
<a class="sourceLine" id="cb3-27" data-line-number="27"><span class="bu">print</span>(np.squeeze(xs[<span class="st">&#39;x&#39;</span>][<span class="dv">1</span>]))</a>
<a class="sourceLine" id="cb3-28" data-line-number="28"><span class="bu">print</span>(xs[<span class="st">&#39;x&#39;</span>][<span class="bu">range</span>(<span class="dv">2</span>),[<span class="dv">1</span>,<span class="dv">2</span>]])</a>
<a class="sourceLine" id="cb3-29" data-line-number="29"><span class="bu">print</span>(<span class="bu">type</span>(y))</a>
<a class="sourceLine" id="cb3-30" data-line-number="30"><span class="bu">print</span>(np.size(y))</a></code></pre></div>
<p>[array([[ 0.29952478, -0.02905731, -0.14833574, -0.25489837, 0.13668409], [ 0.36393905, -0.18847883, 0.01317748, 0.02921137, -0.3228819 ], [ 0.20875314, -0.471264 , -0.23475473, -0.10564104, -0.1293019 ]], dtype=float32)] 12 x: [[ 1 2 3 0] [ 4 5 6 8] [23 1 0 0]] x_star: [[15. 25. 0. ] [23.1 0. 0. ] [ 1. 2. 3. ]] y: [[1] [2] [3]] testing pad for lstm testing feature columns for lstm testing string feature columns [[b'a' b'b'] [b'a' b'0'] [b'b' b'0']] [4 5 6 8] [2 6] &lt;class 'numpy.ndarray'&gt; 3</p>
<h1 id="tensorflow-lstm-cell">Tensorflow LSTM CELL</h1>
<h2 id="single-cell-case">Single cell case</h2>
<p>test the output of LSTM cell</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode python"><code class="sourceCode python"><a class="sourceLine" id="cb4-1" data-line-number="1"><span class="im">import</span> tensorflow <span class="im">as</span> tf</a>
<a class="sourceLine" id="cb4-2" data-line-number="2"><span class="im">import</span> numpy <span class="im">as</span> np</a>
<a class="sourceLine" id="cb4-3" data-line-number="3"><span class="im">from</span> tensorflow.contrib <span class="im">import</span> rnn</a>
<a class="sourceLine" id="cb4-4" data-line-number="4">tf.reset_default_graph()</a>
<a class="sourceLine" id="cb4-5" data-line-number="5"></a>
<a class="sourceLine" id="cb4-6" data-line-number="6"><span class="co"># Create input data</span></a>
<a class="sourceLine" id="cb4-7" data-line-number="7">X <span class="op">=</span> np.random.randn(<span class="dv">2</span>, <span class="dv">10</span>, <span class="dv">8</span>)</a>
<a class="sourceLine" id="cb4-8" data-line-number="8"></a>
<a class="sourceLine" id="cb4-9" data-line-number="9"><span class="co"># The second example is of length 6 </span></a>
<a class="sourceLine" id="cb4-10" data-line-number="10">X[<span class="dv">1</span>,<span class="dv">6</span>:] <span class="op">=</span> <span class="dv">0</span>   <span class="co"># 2D: include all third dimension</span></a>
<a class="sourceLine" id="cb4-11" data-line-number="11">X_lengths <span class="op">=</span> [<span class="dv">10</span>, <span class="dv">6</span>]</a>
<a class="sourceLine" id="cb4-12" data-line-number="12"></a>
<a class="sourceLine" id="cb4-13" data-line-number="13">cell <span class="op">=</span> tf.nn.rnn_cell.LSTMCell(num_units<span class="op">=</span><span class="dv">64</span>, state_is_tuple<span class="op">=</span><span class="va">True</span>)</a>
<a class="sourceLine" id="cb4-14" data-line-number="14"></a>
<a class="sourceLine" id="cb4-15" data-line-number="15">init_state <span class="op">=</span> np.random.randn(<span class="dv">2</span>, <span class="dv">64</span>) <span class="co">#batch_size * hidden_state_size</span></a>
<a class="sourceLine" id="cb4-16" data-line-number="16">init_s <span class="op">=</span>  tf.contrib.rnn.LSTMStateTuple(c<span class="op">=</span> tf.convert_to_tensor(init_state), h<span class="op">=</span> tf.convert_to_tensor(init_state))</a>
<a class="sourceLine" id="cb4-17" data-line-number="17"></a>
<a class="sourceLine" id="cb4-18" data-line-number="18"></a>
<a class="sourceLine" id="cb4-19" data-line-number="19">outputs, states  <span class="op">=</span> tf.nn.dynamic_rnn(cell<span class="op">=</span>cell,</a>
<a class="sourceLine" id="cb4-20" data-line-number="20">dtype<span class="op">=</span>tf.float64,</a>
<a class="sourceLine" id="cb4-21" data-line-number="21">initial_state <span class="op">=</span> init_s,</a>
<a class="sourceLine" id="cb4-22" data-line-number="22">sequence_length<span class="op">=</span>X_lengths,</a>
<a class="sourceLine" id="cb4-23" data-line-number="23">inputs<span class="op">=</span>X)</a>
<a class="sourceLine" id="cb4-24" data-line-number="24"></a>
<a class="sourceLine" id="cb4-25" data-line-number="25"></a>
<a class="sourceLine" id="cb4-26" data-line-number="26"><span class="cf">with</span> tf.Session() <span class="im">as</span> sess:</a>
<a class="sourceLine" id="cb4-27" data-line-number="27">sess.run(tf.global_variables_initializer())</a>
<a class="sourceLine" id="cb4-28" data-line-number="28">output_val, state_val <span class="op">=</span> sess.run([outputs, states])</a>
<a class="sourceLine" id="cb4-29" data-line-number="29"><span class="bu">print</span>(output_val.shape)</a>
<a class="sourceLine" id="cb4-30" data-line-number="30"><span class="bu">print</span>(state_val.c.shape)</a>
<a class="sourceLine" id="cb4-31" data-line-number="31"></a>
<a class="sourceLine" id="cb4-32" data-line-number="32"></a>
<a class="sourceLine" id="cb4-33" data-line-number="33"></a>
<a class="sourceLine" id="cb4-34" data-line-number="34"></a>
<a class="sourceLine" id="cb4-35" data-line-number="35"><span class="cf">assert</span> outputs.shape <span class="op">==</span> (<span class="dv">2</span>, <span class="dv">10</span>, <span class="dv">64</span>)</a>
<a class="sourceLine" id="cb4-36" data-line-number="36"><span class="co"># the final outputs state and states returned must be equal for each      </span></a>
<a class="sourceLine" id="cb4-37" data-line-number="37"><span class="co"># sequence</span></a>
<a class="sourceLine" id="cb4-38" data-line-number="38"><span class="bu">print</span>(outputs)  <span class="co">#all ten outputs of two samples</span></a>
<a class="sourceLine" id="cb4-39" data-line-number="39"><span class="bu">print</span>(states)   <span class="co">#cell states and hidden units: all two sequence state output of two trajectory</span></a></code></pre></div>
<p>(2, 10, 64) (2, 64) Tensor(&quot;rnn/transpose_1:0&quot;, shape=(2, 10, 64), dtype=float64) LSTMStateTuple(c=&lt;tf.Tensor 'rnn/while/Exit_3:0' shape=(2, 64) dtype=float64&gt;, h=&lt;tf.Tensor 'rnn/while/Exit_4:0' shape=(2, 64) dtype=float64&gt;)</p>
<h2 id="multicell-case">Multicell case</h2>
<div class="sourceCode" id="cb5"><pre class="sourceCode python"><code class="sourceCode python"><a class="sourceLine" id="cb5-1" data-line-number="1">tf.reset_default_graph()</a>
<a class="sourceLine" id="cb5-2" data-line-number="2"></a>
<a class="sourceLine" id="cb5-3" data-line-number="3"><span class="co">#cell = tf.nn.rnn_cell.LSTMCell(num_units=64, state_is_tuple=True)</span></a>
<a class="sourceLine" id="cb5-4" data-line-number="4">multi_cell <span class="op">=</span> tf.nn.rnn_cell.MultiRNNCell([tf.nn.rnn_cell.LSTMCell(num_units<span class="op">=</span><span class="dv">64</span>, state_is_tuple<span class="op">=</span><span class="va">True</span>), tf.nn.rnn_cell.LSTMCell(num_units<span class="op">=</span><span class="dv">64</span>, state_is_tuple<span class="op">=</span><span class="va">True</span>)])</a>
<a class="sourceLine" id="cb5-5" data-line-number="5"></a>
<a class="sourceLine" id="cb5-6" data-line-number="6">init_state <span class="op">=</span> np.random.randn(<span class="dv">2</span>, <span class="dv">64</span>)</a>
<a class="sourceLine" id="cb5-7" data-line-number="7">init_s <span class="op">=</span>  tf.contrib.rnn.LSTMStateTuple(c<span class="op">=</span> tf.convert_to_tensor(init_state), h<span class="op">=</span> tf.convert_to_tensor(init_state))</a>
<a class="sourceLine" id="cb5-8" data-line-number="8"></a>
<a class="sourceLine" id="cb5-9" data-line-number="9"></a>
<a class="sourceLine" id="cb5-10" data-line-number="10">outputs, states  <span class="op">=</span> tf.nn.dynamic_rnn(cell<span class="op">=</span>multi_cell,</a>
<a class="sourceLine" id="cb5-11" data-line-number="11">dtype<span class="op">=</span>tf.float64,</a>
<a class="sourceLine" id="cb5-12" data-line-number="12">initial_state <span class="op">=</span> (init_s, init_s),</a>
<a class="sourceLine" id="cb5-13" data-line-number="13">sequence_length<span class="op">=</span>X_lengths,</a>
<a class="sourceLine" id="cb5-14" data-line-number="14">inputs<span class="op">=</span>X)</a>
<a class="sourceLine" id="cb5-15" data-line-number="15"></a>
<a class="sourceLine" id="cb5-16" data-line-number="16"></a>
<a class="sourceLine" id="cb5-17" data-line-number="17"><span class="cf">with</span> tf.Session() <span class="im">as</span> sess:</a>
<a class="sourceLine" id="cb5-18" data-line-number="18">sess.run(tf.global_variables_initializer())</a>
<a class="sourceLine" id="cb5-19" data-line-number="19">a<span class="op">=</span> sess.run(tf.sigmoid(X))</a>
<a class="sourceLine" id="cb5-20" data-line-number="20"></a>
<a class="sourceLine" id="cb5-21" data-line-number="21">output_val, state_val <span class="op">=</span> sess.run([outputs, states])</a>
<a class="sourceLine" id="cb5-22" data-line-number="22"><span class="bu">print</span>(<span class="bu">type</span>(output_val))</a>
<a class="sourceLine" id="cb5-23" data-line-number="23"><span class="bu">print</span>(output_val[:,<span class="dv">1</span>:,:].shape)</a>
<a class="sourceLine" id="cb5-24" data-line-number="24"><span class="bu">print</span>(<span class="st">&#39;Something related to StateTuple&#39;</span>)</a></code></pre></div>
<p>&lt;class 'numpy.ndarray'&gt; (2, 9, 64) Something related to StateTuple</p>
<h1 id="fast-predict">fast predict</h1>
<h2 id="tensorflow-fast-predict">tensorflow fast predict</h2>
<p>use generator to keep .predict open</p>
<p>Why you need this? Detailed explanation <a href="https://stackoverflow.com/questions/51403540/tensorflow-estimator-predict-without-loading-from-checkpoint-everytime" target="_blank" rel="noopener">here</a></p>
<div class="sourceCode" id="cb6"><pre class="sourceCode python"><code class="sourceCode python"><a class="sourceLine" id="cb6-1" data-line-number="1"><span class="im">import</span> tensorflow <span class="im">as</span> tf</a>
<a class="sourceLine" id="cb6-2" data-line-number="2"></a>
<a class="sourceLine" id="cb6-3" data-line-number="3"><span class="kw">class</span> FastPredict:</a>
<a class="sourceLine" id="cb6-4" data-line-number="4"></a>
<a class="sourceLine" id="cb6-5" data-line-number="5"><span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, estimator, input_fn):</a>
<a class="sourceLine" id="cb6-6" data-line-number="6"><span class="va">self</span>.estimator <span class="op">=</span> estimator</a>
<a class="sourceLine" id="cb6-7" data-line-number="7"><span class="va">self</span>.first_run <span class="op">=</span> <span class="va">True</span></a>
<a class="sourceLine" id="cb6-8" data-line-number="8"><span class="va">self</span>.closed <span class="op">=</span> <span class="va">False</span></a>
<a class="sourceLine" id="cb6-9" data-line-number="9"><span class="va">self</span>.input_fn <span class="op">=</span> input_fn</a>
<a class="sourceLine" id="cb6-10" data-line-number="10"></a>
<a class="sourceLine" id="cb6-11" data-line-number="11"><span class="kw">def</span> _create_generator(<span class="va">self</span>):</a>
<a class="sourceLine" id="cb6-12" data-line-number="12"><span class="cf">while</span> <span class="kw">not</span> <span class="va">self</span>.closed:</a>
<a class="sourceLine" id="cb6-13" data-line-number="13"><span class="cf">yield</span> <span class="va">self</span>.next_features</a>
<a class="sourceLine" id="cb6-14" data-line-number="14"></a>
<a class="sourceLine" id="cb6-15" data-line-number="15"><span class="kw">def</span> predict(<span class="va">self</span>, feature_batch):</a>
<a class="sourceLine" id="cb6-16" data-line-number="16"><span class="co">&quot;&quot;&quot; Runs a prediction on a set of features. Calling multiple times</span></a>
<a class="sourceLine" id="cb6-17" data-line-number="17"><span class="co">does *not* regenerate the graph which makes predict much faster.</span></a>
<a class="sourceLine" id="cb6-18" data-line-number="18"><span class="co">feature_batch a list of list of features. IMPORTANT: If you&#39;re only classifying 1 thing,</span></a>
<a class="sourceLine" id="cb6-19" data-line-number="19"><span class="co">you still need to make it a batch of 1 by wrapping it in a list (i.e. predict([my_feature]), not predict(my_feature) </span></a>
<a class="sourceLine" id="cb6-20" data-line-number="20"><span class="co">&quot;&quot;&quot;</span></a>
<a class="sourceLine" id="cb6-21" data-line-number="21"><span class="va">self</span>.next_features <span class="op">=</span> feature_batch</a>
<a class="sourceLine" id="cb6-22" data-line-number="22"><span class="cf">if</span> <span class="va">self</span>.first_run:</a>
<a class="sourceLine" id="cb6-23" data-line-number="23"><span class="va">self</span>.batch_size <span class="op">=</span> <span class="bu">len</span>(feature_batch)</a>
<a class="sourceLine" id="cb6-24" data-line-number="24"><span class="va">self</span>.predictions <span class="op">=</span> <span class="va">self</span>.estimator.predict(</a>
<a class="sourceLine" id="cb6-25" data-line-number="25">input_fn<span class="op">=</span><span class="va">self</span>.input_fn(<span class="va">self</span>._create_generator))</a>
<a class="sourceLine" id="cb6-26" data-line-number="26"><span class="va">self</span>.first_run <span class="op">=</span> <span class="va">False</span></a>
<a class="sourceLine" id="cb6-27" data-line-number="27"><span class="cf">elif</span> <span class="va">self</span>.batch_size <span class="op">!=</span> <span class="bu">len</span>(feature_batch):</a>
<a class="sourceLine" id="cb6-28" data-line-number="28"><span class="cf">raise</span> <span class="pp">ValueError</span>(<span class="st">&quot;All batches must be of the same size. First-batch:&quot;</span> <span class="op">+</span> <span class="bu">str</span>(<span class="va">self</span>.batch_size) <span class="op">+</span> <span class="st">&quot; This-batch:&quot;</span> <span class="op">+</span> <span class="bu">str</span>(<span class="bu">len</span>(feature_batch)))</a>
<a class="sourceLine" id="cb6-29" data-line-number="29"></a>
<a class="sourceLine" id="cb6-30" data-line-number="30">results <span class="op">=</span> []</a>
<a class="sourceLine" id="cb6-31" data-line-number="31"><span class="cf">for</span> _ <span class="kw">in</span> <span class="bu">range</span>(<span class="va">self</span>.batch_size):</a>
<a class="sourceLine" id="cb6-32" data-line-number="32">results.append(<span class="bu">next</span>(<span class="va">self</span>.predictions))</a>
<a class="sourceLine" id="cb6-33" data-line-number="33"><span class="cf">return</span> results</a>
<a class="sourceLine" id="cb6-34" data-line-number="34"></a>
<a class="sourceLine" id="cb6-35" data-line-number="35"><span class="kw">def</span> close(<span class="va">self</span>):</a>
<a class="sourceLine" id="cb6-36" data-line-number="36"><span class="va">self</span>.closed <span class="op">=</span> <span class="va">True</span></a>
<a class="sourceLine" id="cb6-37" data-line-number="37"><span class="cf">try</span>:</a>
<a class="sourceLine" id="cb6-38" data-line-number="38"><span class="bu">next</span>(<span class="va">self</span>.predictions)</a>
<a class="sourceLine" id="cb6-39" data-line-number="39"><span class="cf">except</span>:</a>
<a class="sourceLine" id="cb6-40" data-line-number="40"><span class="bu">print</span>(<span class="st">&quot;Exception in fast_predict. This is probably OK&quot;</span>)</a>
<a class="sourceLine" id="cb6-41" data-line-number="41"></a>
<a class="sourceLine" id="cb6-42" data-line-number="42"></a>
<a class="sourceLine" id="cb6-43" data-line-number="43"><span class="kw">def</span> example_input_fn(generator):</a>
<a class="sourceLine" id="cb6-44" data-line-number="44"><span class="co">&quot;&quot;&quot; An example input function to pass to predict. It must take a generator as input &quot;&quot;&quot;</span></a>
<a class="sourceLine" id="cb6-45" data-line-number="45"></a>
<a class="sourceLine" id="cb6-46" data-line-number="46"><span class="kw">def</span> _inner_input_fn():</a>
<a class="sourceLine" id="cb6-47" data-line-number="47">dataset <span class="op">=</span> tf.data.Dataset().from_generator(generator, output_types<span class="op">=</span>{<span class="st">&#39;a&#39;</span>:(<span class="dv">10</span>,),<span class="st">&#39;b&#39;</span>:(<span class="dv">2</span>,)}).batch(<span class="dv">1</span>)</a>
<a class="sourceLine" id="cb6-48" data-line-number="48">iterator <span class="op">=</span> dataset.make_one_shot_iterator()</a>
<a class="sourceLine" id="cb6-49" data-line-number="49">features <span class="op">=</span> iterator.get_next()</a>
<a class="sourceLine" id="cb6-50" data-line-number="50"><span class="cf">return</span> features</a>
<a class="sourceLine" id="cb6-51" data-line-number="51"></a>
<a class="sourceLine" id="cb6-52" data-line-number="52"><span class="cf">return</span> _inner_input_fn</a></code></pre></div>
<h2 id="tf.data.dataset.from_generator">tf.data.Dataset().from_generator</h2>
<div class="sourceCode" id="cb7"><pre class="sourceCode python"><code class="sourceCode python"><a class="sourceLine" id="cb7-1" data-line-number="1"><span class="im">import</span> numpy <span class="im">as</span> np</a>
<a class="sourceLine" id="cb7-2" data-line-number="2"><span class="kw">def</span> _create_generator():</a>
<a class="sourceLine" id="cb7-3" data-line-number="3"><span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">3</span>):</a>
<a class="sourceLine" id="cb7-4" data-line-number="4">a <span class="op">=</span> np.random.randn(<span class="dv">3</span>,<span class="dv">2</span>)</a>
<a class="sourceLine" id="cb7-5" data-line-number="5">b <span class="op">=</span> np.random.randn(<span class="dv">2</span>)</a>
<a class="sourceLine" id="cb7-6" data-line-number="6">result <span class="op">=</span> {}</a>
<a class="sourceLine" id="cb7-7" data-line-number="7">result[<span class="st">&#39;a&#39;</span>] <span class="op">=</span>  a</a>
<a class="sourceLine" id="cb7-8" data-line-number="8">result[<span class="st">&#39;b&#39;</span>] <span class="op">=</span> b</a>
<a class="sourceLine" id="cb7-9" data-line-number="9"><span class="cf">yield</span> result</a>
<a class="sourceLine" id="cb7-10" data-line-number="10"></a>
<a class="sourceLine" id="cb7-11" data-line-number="11"></a>
<a class="sourceLine" id="cb7-12" data-line-number="12">gen <span class="op">=</span> _create_generator()</a>
<a class="sourceLine" id="cb7-13" data-line-number="13"></a>
<a class="sourceLine" id="cb7-14" data-line-number="14">dataset <span class="op">=</span> tf.data.Dataset().from_generator(_create_generator,</a>
<a class="sourceLine" id="cb7-15" data-line-number="15">output_shapes<span class="op">=</span>{<span class="st">&#39;a&#39;</span>:(<span class="dv">3</span>,<span class="dv">2</span>),<span class="st">&#39;b&#39;</span>:<span class="dv">2</span>},</a>
<a class="sourceLine" id="cb7-16" data-line-number="16">output_types <span class="op">=</span>{<span class="st">&#39;a&#39;</span>:tf.float32, <span class="st">&#39;b&#39;</span>:tf.float32}).batch(<span class="dv">1</span>)</a>
<a class="sourceLine" id="cb7-17" data-line-number="17">iterator <span class="op">=</span> dataset.make_one_shot_iterator()</a>
<a class="sourceLine" id="cb7-18" data-line-number="18">features <span class="op">=</span> iterator.get_next()</a>
<a class="sourceLine" id="cb7-19" data-line-number="19"></a>
<a class="sourceLine" id="cb7-20" data-line-number="20"></a>
<a class="sourceLine" id="cb7-21" data-line-number="21">init <span class="op">=</span> tf.initialize_all_variables()</a>
<a class="sourceLine" id="cb7-22" data-line-number="22"><span class="cf">with</span> tf.Session() <span class="im">as</span> sess:</a>
<a class="sourceLine" id="cb7-23" data-line-number="23">sess.run(init)</a>
<a class="sourceLine" id="cb7-24" data-line-number="24"><span class="bu">print</span>(sess.run(features))</a></code></pre></div>
<p>WARNING:tensorflow:From /Library/Frameworks/Python.framework/Versions/3.6/lib/python3.6/site-packages/tensorflow/python/util/tf_should_use.py:118: initialize_all_variables (from tensorflow.python.ops.variables) is deprecated and will be removed after 2017-03-02. Instructions for updating: Use <code>tf.global_variables_initializer</code> instead. {'a': array([[[ 0.6078665 , 0.7673362 ], [-1.095272 , -0.44154257], [ 0.24826635, 1.8101764 ]]], dtype=float32), 'b': array([[-1.3138337 , 0.05587422]], dtype=float32)}</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode python"><code class="sourceCode python"><a class="sourceLine" id="cb8-1" data-line-number="1"><span class="im">import</span> numpy <span class="im">as</span> np</a>
<a class="sourceLine" id="cb8-2" data-line-number="2"><span class="kw">def</span> _create_generator():</a>
<a class="sourceLine" id="cb8-3" data-line-number="3"><span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">3</span>):</a>
<a class="sourceLine" id="cb8-4" data-line-number="4">a <span class="op">=</span> np.random.randn(<span class="dv">3</span>,<span class="dv">2</span>)</a>
<a class="sourceLine" id="cb8-5" data-line-number="5">b <span class="op">=</span> np.random.randn(<span class="dv">2</span>)</a>
<a class="sourceLine" id="cb8-6" data-line-number="6">result <span class="op">=</span> {}</a>
<a class="sourceLine" id="cb8-7" data-line-number="7">result[<span class="st">&#39;a&#39;</span>] <span class="op">=</span> tf.contrib.rnn.LSTMStateTuple(c<span class="op">=</span>a, h<span class="op">=</span>b)</a>
<a class="sourceLine" id="cb8-8" data-line-number="8"><span class="cf">yield</span> result</a>
<a class="sourceLine" id="cb8-9" data-line-number="9"></a>
<a class="sourceLine" id="cb8-10" data-line-number="10"></a>
<a class="sourceLine" id="cb8-11" data-line-number="11">gen <span class="op">=</span> _create_generator()</a>
<a class="sourceLine" id="cb8-12" data-line-number="12"></a>
<a class="sourceLine" id="cb8-13" data-line-number="13">dataset <span class="op">=</span> tf.data.Dataset().from_generator(_create_generator,</a>
<a class="sourceLine" id="cb8-14" data-line-number="14">output_types <span class="op">=</span>{<span class="st">&#39;a&#39;</span>:tf.contrib.rnn.LSTMStateTuple(c<span class="op">=</span>tf.float32, h<span class="op">=</span>tf.float32)}).batch(<span class="dv">1</span>)</a>
<a class="sourceLine" id="cb8-15" data-line-number="15"></a>
<a class="sourceLine" id="cb8-16" data-line-number="16">iterator <span class="op">=</span> dataset.make_one_shot_iterator()</a>
<a class="sourceLine" id="cb8-17" data-line-number="17">features <span class="op">=</span> iterator.get_next()</a>
<a class="sourceLine" id="cb8-18" data-line-number="18"></a>
<a class="sourceLine" id="cb8-19" data-line-number="19"></a>
<a class="sourceLine" id="cb8-20" data-line-number="20">init <span class="op">=</span> tf.global_variables_initializer()</a>
<a class="sourceLine" id="cb8-21" data-line-number="21"><span class="cf">with</span> tf.Session() <span class="im">as</span> sess:</a>
<a class="sourceLine" id="cb8-22" data-line-number="22">sess.run(init)</a>
<a class="sourceLine" id="cb8-23" data-line-number="23">g <span class="op">=</span> sess.run(features)</a>
<a class="sourceLine" id="cb8-24" data-line-number="24"><span class="bu">print</span>(g[<span class="st">&#39;a&#39;</span>])</a></code></pre></div>
<p>LSTMStateTuple(c=array([[[ 0.15593866, -1.1535455 ], [ 0.8337963 , 0.3000586 ], [ 1.3395942 , -0.65611506]]], dtype=float32), h=array([[ 0.5950521 , -0.82992613]], dtype=float32))</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode python"><code class="sourceCode python"><a class="sourceLine" id="cb9-1" data-line-number="1"><span class="im">import</span> os</a>
<a class="sourceLine" id="cb9-2" data-line-number="2"><span class="bu">print</span>(os.environ.get(<span class="st">&#39;CONFIG&#39;</span>))</a></code></pre></div>
<p>None</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode python"><code class="sourceCode python"><a class="sourceLine" id="cb10-1" data-line-number="1"><span class="im">import</span> tensorflow <span class="im">as</span> tf</a>
<a class="sourceLine" id="cb10-2" data-line-number="2">hparams <span class="op">=</span> tf.contrib.training.HParams(</a>
<a class="sourceLine" id="cb10-3" data-line-number="3">learning_rate<span class="op">=</span><span class="fl">0.1</span>, num_hidden_units<span class="op">=</span><span class="dv">100</span>, activation<span class="op">=</span><span class="st">&#39;relu&#39;</span>)</a>
<a class="sourceLine" id="cb10-4" data-line-number="4"><span class="bu">print</span>(hparams.get(<span class="st">&#39;learning_rate2&#39;</span>, <span class="va">None</span>))</a>
<a class="sourceLine" id="cb10-5" data-line-number="5">hparams.add_hparam(<span class="st">&#39;test2&#39;</span>, <span class="dv">2</span>)</a>
<a class="sourceLine" id="cb10-6" data-line-number="6"><span class="co">#None &gt; 2   # can&#39;t compare None with 2</span></a></code></pre></div>
<p>None</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode python"><code class="sourceCode python"><a class="sourceLine" id="cb11-1" data-line-number="1"><span class="im">import</span> configparser <span class="im">as</span> cp</a>
<a class="sourceLine" id="cb11-2" data-line-number="2">target <span class="op">=</span> cp.ConfigParser()</a>
<a class="sourceLine" id="cb11-3" data-line-number="3">config <span class="op">=</span> target.read(<span class="st">&#39;single.ini&#39;</span>)</a>
<a class="sourceLine" id="cb11-4" data-line-number="4"></a>
<a class="sourceLine" id="cb11-5" data-line-number="5"><span class="co">#use config to get variours params</span></a></code></pre></div>
<h1 id="test-shared-embedding">test shared embedding</h1>
<h3 id="how-to-use-embedding">1. How to use embedding</h3>
<p>tf.feature_column.input_layer(.., ..)</p>
<h3 id="how-tf.varlen-react-when-read-in-batch">2. How tf.Varlen react when read in batch</h3>
<p>data is in format tf.SparseTensor</p>
<h3 id="embedding-make_parse_example_spec">embedding: make_parse_example_spec</h3>
<p>it is <code>tf.Varlen</code> because embedding can be multiple dimension, and then you can <code>combine</code> them by sum, mean, etc.</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode python"><code class="sourceCode python"><a class="sourceLine" id="cb12-1" data-line-number="1">fc <span class="op">=</span> tf.feature_column.categorical_column_with_hash_bucket(<span class="st">&#39;my_fc&#39;</span>,</a>
<a class="sourceLine" id="cb12-2" data-line-number="2"><span class="dv">10</span>)</a>
<a class="sourceLine" id="cb12-3" data-line-number="3"></a>
<a class="sourceLine" id="cb12-4" data-line-number="4">shared_columns <span class="op">=</span> tf.feature_column.shared_embedding_columns([fc],</a>
<a class="sourceLine" id="cb12-5" data-line-number="5"><span class="dv">32</span>, combiner<span class="op">=</span><span class="st">&#39;sum&#39;</span>,</a>
<a class="sourceLine" id="cb12-6" data-line-number="6">shared_embedding_collection_name<span class="op">=</span><span class="st">&#39;my_em_fc&#39;</span>)</a>
<a class="sourceLine" id="cb12-7" data-line-number="7">tf.feature_column.make_parse_example_spec(shared_columns)     </a></code></pre></div>
<p>{'my_fc': VarLenFeature(dtype=tf.string)}</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode python"><code class="sourceCode python"><a class="sourceLine" id="cb13-1" data-line-number="1">fc <span class="op">=</span> tf.feature_column.categorical_column_with_vocabulary_file(<span class="st">&#39;my_fc&#39;</span>,vocabulary_file<span class="op">=</span><span class="st">&#39;abc&#39;</span>,vocabulary_size<span class="op">=</span><span class="dv">100</span>, </a>
<a class="sourceLine" id="cb13-2" data-line-number="2">num_oov_buckets<span class="op">=</span> <span class="dv">10</span>)</a>
<a class="sourceLine" id="cb13-3" data-line-number="3"></a>
<a class="sourceLine" id="cb13-4" data-line-number="4">shared_columns <span class="op">=</span> tf.feature_column.shared_embedding_columns([fc],</a>
<a class="sourceLine" id="cb13-5" data-line-number="5"><span class="dv">32</span>, combiner<span class="op">=</span><span class="st">&#39;sum&#39;</span>,</a>
<a class="sourceLine" id="cb13-6" data-line-number="6">shared_embedding_collection_name<span class="op">=</span><span class="st">&#39;my_em_fc&#39;</span>)</a>
<a class="sourceLine" id="cb13-7" data-line-number="7">tf.feature_column.make_parse_example_spec(shared_columns)     </a></code></pre></div>
<p>{'my_fc': VarLenFeature(dtype=tf.string)}</p>
<h2 id="check-tf.varlen">check tf.varlen</h2>
<div class="sourceCode" id="cb14"><pre class="sourceCode python"><code class="sourceCode python"><a class="sourceLine" id="cb14-1" data-line-number="1">fc <span class="op">=</span> tf.feature_column.categorical_column_with_vocabulary_file(<span class="st">&#39;my_fc&#39;</span>,vocabulary_file<span class="op">=</span><span class="st">&#39;abc&#39;</span>,vocabulary_size<span class="op">=</span><span class="dv">100</span>, </a>
<a class="sourceLine" id="cb14-2" data-line-number="2">num_oov_buckets<span class="op">=</span> <span class="dv">10</span>)</a>
<a class="sourceLine" id="cb14-3" data-line-number="3"></a>
<a class="sourceLine" id="cb14-4" data-line-number="4">shared_columns <span class="op">=</span> tf.feature_column.shared_embedding_columns([fc],</a>
<a class="sourceLine" id="cb14-5" data-line-number="5"><span class="dv">32</span>, combiner<span class="op">=</span><span class="st">&#39;sum&#39;</span>,</a>
<a class="sourceLine" id="cb14-6" data-line-number="6">shared_embedding_collection_name<span class="op">=</span><span class="st">&#39;my_em_fc&#39;</span>, )</a>
<a class="sourceLine" id="cb14-7" data-line-number="7">target <span class="op">=</span> tf.feature_column.make_parse_example_spec(shared_columns)     </a>
<a class="sourceLine" id="cb14-8" data-line-number="8"><span class="cf">for</span> key, item <span class="kw">in</span> target.items():</a>
<a class="sourceLine" id="cb14-9" data-line-number="9"><span class="bu">print</span>(<span class="bu">type</span>(item) <span class="op">==</span> tf.VarLenFeature)</a>
<a class="sourceLine" id="cb14-10" data-line-number="10"><span class="bu">print</span>(item)</a>
<a class="sourceLine" id="cb14-11" data-line-number="11"><span class="bu">print</span>(key)</a>
<a class="sourceLine" id="cb14-12" data-line-number="12"><span class="bu">print</span>(<span class="bu">type</span>(shared_columns[<span class="dv">0</span>]))</a>
<a class="sourceLine" id="cb14-13" data-line-number="13"><span class="bu">print</span>(shared_columns[<span class="dv">0</span>])</a>
<a class="sourceLine" id="cb14-14" data-line-number="14"><span class="bu">print</span>(<span class="st">&#39;_SharedEmbeddingColumn&#39;</span> <span class="kw">in</span>  <span class="bu">str</span>(<span class="bu">type</span>(shared_columns[<span class="dv">0</span>])))</a>
<a class="sourceLine" id="cb14-15" data-line-number="15">a<span class="op">=</span> shared_columns[<span class="dv">0</span>]</a>
<a class="sourceLine" id="cb14-16" data-line-number="16"><span class="bu">print</span>(shared_columns[<span class="dv">0</span>].name)</a></code></pre></div>
<p>True VarLenFeature(dtype=tf.string) my_fc &lt;class 'tensorflow.python.feature_column.feature_column._SharedEmbeddingColumn'&gt; _SharedEmbeddingColumn(categorical_column=_VocabularyFileCategoricalColumn(key='my_fc', vocabulary_file='abc', vocabulary_size=100, num_oov_buckets=10, dtype=tf.string, default_value=-1), dimension=32, combiner='sum', initializer=&lt;tensorflow.python.ops.init_ops.TruncatedNormal object at 0x11e6f6668&gt;, shared_embedding_collection_name='my_em_fc', ckpt_to_load_from=None, tensor_name_in_ckpt=None, max_norm=None, trainable=True) True my_fc_shared_embedding</p>
<h2 id="check-naming-of-these-method">check naming of these method</h2>
<div class="sourceCode" id="cb15"><pre class="sourceCode python"><code class="sourceCode python"><a class="sourceLine" id="cb15-1" data-line-number="1">fc <span class="op">=</span> tf.feature_column.categorical_column_with_vocabulary_list(<span class="st">&#39;my_fc&#39;</span>,vocabulary_list<span class="op">=</span>[<span class="st">&#39;a&#39;</span>,<span class="st">&#39;b&#39;</span>], </a>
<a class="sourceLine" id="cb15-2" data-line-number="2">num_oov_buckets<span class="op">=</span> <span class="dv">10</span>)</a>
<a class="sourceLine" id="cb15-3" data-line-number="3"></a>
<a class="sourceLine" id="cb15-4" data-line-number="4">shared_columns <span class="op">=</span> tf.feature_column.shared_embedding_columns([fc],</a>
<a class="sourceLine" id="cb15-5" data-line-number="5"><span class="dv">32</span>, combiner<span class="op">=</span><span class="st">&#39;mean&#39;</span>,</a>
<a class="sourceLine" id="cb15-6" data-line-number="6">shared_embedding_collection_name<span class="op">=</span><span class="st">&#39;my_em_fc&#39;</span>)</a>
<a class="sourceLine" id="cb15-7" data-line-number="7"></a>
<a class="sourceLine" id="cb15-8" data-line-number="8">indicated_columns <span class="op">=</span> tf.feature_column.indicator_column(fc)</a>
<a class="sourceLine" id="cb15-9" data-line-number="9"></a>
<a class="sourceLine" id="cb15-10" data-line-number="10"></a>
<a class="sourceLine" id="cb15-11" data-line-number="11"></a>
<a class="sourceLine" id="cb15-12" data-line-number="12">boundaries<span class="op">=</span> [<span class="fl">1.0</span>,<span class="fl">2.0</span>]</a>
<a class="sourceLine" id="cb15-13" data-line-number="13">source_column <span class="op">=</span> tf.feature_column.numeric_column(<span class="st">&#39;day&#39;</span>, <span class="dv">2</span>)</a>
<a class="sourceLine" id="cb15-14" data-line-number="14">bucketized_column <span class="op">=</span>  tf.feature_column.bucketized_column(source_column,boundaries<span class="op">=</span>boundaries)</a>
<a class="sourceLine" id="cb15-15" data-line-number="15"></a>
<a class="sourceLine" id="cb15-16" data-line-number="16"></a>
<a class="sourceLine" id="cb15-17" data-line-number="17">target <span class="op">=</span> tf.feature_column.make_parse_example_spec(shared_columns)     </a>
<a class="sourceLine" id="cb15-18" data-line-number="18"><span class="bu">print</span>(indicated_columns.name)</a>
<a class="sourceLine" id="cb15-19" data-line-number="19">a<span class="op">=</span> shared_columns[<span class="dv">0</span>]</a>
<a class="sourceLine" id="cb15-20" data-line-number="20"><span class="bu">print</span>(a.name[:<span class="op">-</span><span class="dv">17</span>])</a>
<a class="sourceLine" id="cb15-21" data-line-number="21"><span class="bu">print</span>(a)</a>
<a class="sourceLine" id="cb15-22" data-line-number="22">a.dimension</a>
<a class="sourceLine" id="cb15-23" data-line-number="23">a.combiner <span class="op">==</span> <span class="st">&#39;mean&#39;</span></a>
<a class="sourceLine" id="cb15-24" data-line-number="24"><span class="bu">print</span>(target)</a>
<a class="sourceLine" id="cb15-25" data-line-number="25"><span class="bu">print</span>(<span class="st">&#39;target keys&#39;</span>)</a>
<a class="sourceLine" id="cb15-26" data-line-number="26"><span class="bu">print</span>(<span class="bu">list</span>(target.keys())[<span class="dv">0</span>]) <span class="co">#change datatype to list to support indexing</span></a>
<a class="sourceLine" id="cb15-27" data-line-number="27"></a>
<a class="sourceLine" id="cb15-28" data-line-number="28"><span class="bu">print</span>(source_column.name)</a>
<a class="sourceLine" id="cb15-29" data-line-number="29"><span class="bu">print</span>(bucketized_column.name)</a>
<a class="sourceLine" id="cb15-30" data-line-number="30"></a>
<a class="sourceLine" id="cb15-31" data-line-number="31"><span class="bu">print</span>(tf.feature_column.make_parse_example_spec(indicated_columns))     </a>
<a class="sourceLine" id="cb15-32" data-line-number="32"></a>
<a class="sourceLine" id="cb15-33" data-line-number="33"><span class="bu">print</span>(tf.feature_column.make_parse_example_spec([source_column]))     </a>
<a class="sourceLine" id="cb15-34" data-line-number="34"><span class="bu">print</span>(tf.feature_column.make_parse_example_spec([bucketized_column]))     </a>
<a class="sourceLine" id="cb15-35" data-line-number="35">target[<span class="st">&#39;my_fc&#39;</span>].dtype<span class="op">==</span>tf.string</a></code></pre></div>
<p>my_fc_indicator my_fc _SharedEmbeddingColumn(categorical_column=_VocabularyListCategoricalColumn(key='my_fc', vocabulary_list=('a', 'b'), dtype=tf.string, default_value=-1, num_oov_buckets=10), dimension=32, combiner='mean', initializer=&lt;tensorflow.python.ops.init_ops.TruncatedNormal object at 0x11e6f3668&gt;, shared_embedding_collection_name='my_em_fc', ckpt_to_load_from=None, tensor_name_in_ckpt=None, max_norm=None, trainable=True) {'my_fc': VarLenFeature(dtype=tf.string)} target keys my_fc day day_bucketized {'my_fc': VarLenFeature(dtype=tf.string)} {'day': FixedLenFeature(shape=(2,), dtype=tf.float32, default_value=None)} {'day': FixedLenFeature(shape=(2,), dtype=tf.float32, default_value=None)} True</p>
<h2 id="embedding---input_layer">embedding - input_layer</h2>
<p>embedding layer should be defined before you <code>tf.initialize</code>. Because in most cases is also a trainable layer.</p>
<div class="sourceCode" id="cb16"><pre class="sourceCode python"><code class="sourceCode python"><a class="sourceLine" id="cb16-1" data-line-number="1">target <span class="op">=</span> {}</a>
<a class="sourceLine" id="cb16-2" data-line-number="2">target[<span class="st">&#39;name_star&#39;</span>] <span class="op">=</span> [[b<span class="st">&#39;a&#39;</span>,b<span class="st">&#39;b&#39;</span>,b<span class="st">&#39;&#39;</span>],[b<span class="st">&#39;a&#39;</span>,b<span class="st">&#39;c&#39;</span>,b<span class="st">&#39;d&#39;</span>]]</a>
<a class="sourceLine" id="cb16-3" data-line-number="3"></a>
<a class="sourceLine" id="cb16-4" data-line-number="4">embed_info <span class="op">=</span> tf.feature_column.categorical_column_with_vocabulary_list(</a>
<a class="sourceLine" id="cb16-5" data-line-number="5"><span class="st">&#39;name_star&#39;</span>,</a>
<a class="sourceLine" id="cb16-6" data-line-number="6">[<span class="st">&#39;a&#39;</span>,<span class="st">&#39;b&#39;</span>,<span class="st">&#39;c&#39;</span>,<span class="st">&#39;d&#39;</span>,<span class="st">&#39;e&#39;</span>], default_value<span class="op">=-</span><span class="dv">1</span>,</a>
<a class="sourceLine" id="cb16-7" data-line-number="7">dtype<span class="op">=</span>tf.string, num_oov_buckets<span class="op">=</span><span class="dv">2</span>)</a>
<a class="sourceLine" id="cb16-8" data-line-number="8"></a>
<a class="sourceLine" id="cb16-9" data-line-number="9">name_tensor<span class="op">=</span> tf.feature_column.embedding_column(embed_info, <span class="dv">5</span>)</a>
<a class="sourceLine" id="cb16-10" data-line-number="10"></a>
<a class="sourceLine" id="cb16-11" data-line-number="11">op <span class="op">=</span> tf.feature_column.input_layer(target,feature_columns<span class="op">=</span>name_tensor)</a>
<a class="sourceLine" id="cb16-12" data-line-number="12"></a>
<a class="sourceLine" id="cb16-13" data-line-number="13"></a>
<a class="sourceLine" id="cb16-14" data-line-number="14"><span class="cf">with</span> tf.Session() <span class="im">as</span> sess:</a>
<a class="sourceLine" id="cb16-15" data-line-number="15">sess.run(tf.global_variables_initializer())</a>
<a class="sourceLine" id="cb16-16" data-line-number="16">sess.run(tf.tables_initializer())</a>
<a class="sourceLine" id="cb16-17" data-line-number="17"><span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">1</span>):</a>
<a class="sourceLine" id="cb16-18" data-line-number="18"><span class="bu">print</span>(sess.run([op]))</a></code></pre></div>
<h1 id="miscellany">Miscellany</h1>
<h2 id="tf.gather_nd">tf.gather_nd</h2>
<div class="sourceCode" id="cb17"><pre class="sourceCode python"><code class="sourceCode python"><a class="sourceLine" id="cb17-1" data-line-number="1">a<span class="op">=</span>  np.array([[<span class="dv">1</span>,<span class="dv">2</span>,<span class="dv">3</span>],[<span class="dv">4</span>,<span class="dv">5</span>,<span class="dv">6</span>]])</a>
<a class="sourceLine" id="cb17-2" data-line-number="2">b <span class="op">=</span> tf.convert_to_tensor(a)</a>
<a class="sourceLine" id="cb17-3" data-line-number="3"></a>
<a class="sourceLine" id="cb17-4" data-line-number="4">index <span class="op">=</span>[[<span class="dv">0</span>,<span class="dv">0</span>],[<span class="dv">1</span>,b[<span class="dv">0</span>,<span class="dv">0</span>]]]</a>
<a class="sourceLine" id="cb17-5" data-line-number="5"></a>
<a class="sourceLine" id="cb17-6" data-line-number="6"></a>
<a class="sourceLine" id="cb17-7" data-line-number="7">init <span class="op">=</span> tf.global_variables_initializer()</a>
<a class="sourceLine" id="cb17-8" data-line-number="8"><span class="cf">with</span> tf.Session() <span class="im">as</span> sess:</a>
<a class="sourceLine" id="cb17-9" data-line-number="9">sess.run(init)</a>
<a class="sourceLine" id="cb17-10" data-line-number="10"><span class="bu">print</span>(sess.run(tf.gather_nd(b, index)))</a>
<a class="sourceLine" id="cb17-11" data-line-number="11"><span class="bu">print</span>(<span class="bu">type</span>(b))</a>
<a class="sourceLine" id="cb17-12" data-line-number="12"><span class="bu">print</span>(b[:,<span class="dv">1</span>])</a></code></pre></div>
<h2 id="tf.less-tf.where">tf.less + tf.where</h2>
<div class="sourceCode" id="cb18"><pre class="sourceCode python"><code class="sourceCode python"><a class="sourceLine" id="cb18-1" data-line-number="1"><span class="im">import</span> tensorflow <span class="im">as</span> tf</a>
<a class="sourceLine" id="cb18-2" data-line-number="2"><span class="im">import</span> numpy <span class="im">as</span> np</a>
<a class="sourceLine" id="cb18-3" data-line-number="3">a<span class="op">=</span>  np.array([<span class="dv">1</span>,<span class="dv">2</span>,<span class="dv">3</span>,<span class="dv">4</span>,<span class="dv">2</span>,<span class="dv">4</span>,<span class="dv">2</span>])</a>
<a class="sourceLine" id="cb18-4" data-line-number="4">b <span class="op">=</span> tf.convert_to_tensor(a)</a>
<a class="sourceLine" id="cb18-5" data-line-number="5"></a>
<a class="sourceLine" id="cb18-6" data-line-number="6">result <span class="op">=</span>tf.where(tf.less(b, <span class="dv">3</span>),tf.ones_like(b), tf.zeros_like(b))</a>
<a class="sourceLine" id="cb18-7" data-line-number="7"></a>
<a class="sourceLine" id="cb18-8" data-line-number="8">init <span class="op">=</span> tf.global_variables_initializer()</a>
<a class="sourceLine" id="cb18-9" data-line-number="9"><span class="cf">with</span> tf.Session() <span class="im">as</span> sess:</a>
<a class="sourceLine" id="cb18-10" data-line-number="10">sess.run(init)</a>
<a class="sourceLine" id="cb18-11" data-line-number="11"><span class="bu">print</span>(<span class="bu">type</span>(b))</a>
<a class="sourceLine" id="cb18-12" data-line-number="12"><span class="bu">print</span>(sess.run(result))</a></code></pre></div>
<h2 id="tensor-computation">Tensor computation</h2>
<div class="sourceCode" id="cb19"><pre class="sourceCode python"><code class="sourceCode python"><a class="sourceLine" id="cb19-1" data-line-number="1">a <span class="op">=</span> tf.constant([[<span class="dv">2</span>,<span class="dv">3</span>,<span class="dv">5</span>],[<span class="dv">4</span>,<span class="dv">5</span>,<span class="dv">7</span>]])</a>
<a class="sourceLine" id="cb19-2" data-line-number="2">b <span class="op">=</span> tf.constant([<span class="dv">2</span>,<span class="dv">3</span>])</a>
<a class="sourceLine" id="cb19-3" data-line-number="3"><span class="cf">with</span> tf.Session() <span class="im">as</span> sess:</a>
<a class="sourceLine" id="cb19-4" data-line-number="4"><span class="bu">print</span>(sess.run(a))</a>
<a class="sourceLine" id="cb19-5" data-line-number="5"><span class="bu">print</span>(sess.run(b))</a>
<a class="sourceLine" id="cb19-6" data-line-number="6"><span class="bu">print</span>(sess.run(a<span class="op">/</span>tf.expand_dims(b, <span class="dv">1</span>)))</a></code></pre></div>
<h2 id="tensor-reshape">Tensor reshape</h2>
<p>确认rehsape逻辑，[batch_size, max_len, feature_dim]</p>
<div class="sourceCode" id="cb20"><pre class="sourceCode python"><code class="sourceCode python"><a class="sourceLine" id="cb20-1" data-line-number="1">a <span class="op">=</span> tf.constant([[<span class="dv">2</span>,<span class="dv">3</span>,<span class="dv">5</span>],[<span class="dv">4</span>,<span class="dv">5</span>,<span class="dv">7</span>],[<span class="dv">3</span>,<span class="dv">4</span>,<span class="dv">5</span>],[<span class="dv">1</span>,<span class="dv">5</span>,<span class="dv">9</span>]])</a>
<a class="sourceLine" id="cb20-2" data-line-number="2"></a>
<a class="sourceLine" id="cb20-3" data-line-number="3"><span class="cf">with</span> tf.Session() <span class="im">as</span> sess:</a>
<a class="sourceLine" id="cb20-4" data-line-number="4"><span class="bu">print</span>(sess.run(tf.reshape(a, [<span class="dv">2</span>,<span class="dv">2</span>,<span class="dv">3</span>])))</a></code></pre></div>
<h2 id="import-.py-from-parent-directory">import .py from parent directory</h2>
<div class="sourceCode" id="cb21"><pre class="sourceCode python"><code class="sourceCode python"><a class="sourceLine" id="cb21-1" data-line-number="1"><span class="im">import</span> os, sys</a>
<a class="sourceLine" id="cb21-2" data-line-number="2"></a>
<a class="sourceLine" id="cb21-3" data-line-number="3">sys.path.append(os.path.dirname(os.path.dirname(os.path.abspath(<span class="va">__file__</span>))))</a></code></pre></div>

      
    </div>

    

    
    
    

    
      <div id="wechat_subscriber" style="display: block; padding: 10px 0; margin: 20px auto; width: 100%; text-align: center;">
  <img id="wechat_subscriber_qcode" src="/images/wechat_qcode.JPG" alt="Haonan Li wechat" style="width: 200px; max-width: 100%;">
  <div></div>
</div>

    

    
      
    
    

    

    <footer class="post-footer">
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2018/02/09/Deep-Residual-Learning-For-Image-Recognition/" rel="next" title="Deep Residual Learning For Image Recognition">
                <i class="fa fa-chevron-left"></i> Deep Residual Learning For Image Recognition
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>


  </div>


          </div>
          

  
    <div class="comments" id="comments">
      <div id="disqus_thread">
        <noscript>Please enable JavaScript to view the comments powered by Disqus.</noscript>
      </div>
    </div>

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            站点概览
          </li>
        </ul>
      

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image" src="/images/selfie1.JPG" alt="Haonan Li">
            
              <p class="site-author-name" itemprop="name">Haonan Li</p>
              <div class="site-description motion-element" itemprop="description">Strong Mind = Success</div>
          </div>

          
            <nav class="site-state motion-element">
              
                <div class="site-state-item site-state-posts">
                
                  <a href="/archives/">
                
                    <span class="site-state-item-count">4</span>
                    <span class="site-state-item-name">日志</span>
                  </a>
                </div>
              

              

              
                
                
                <div class="site-state-item site-state-tags">
                  
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">4</span>
                    <span class="site-state-item-name">标签</span>
                  
                </div>
              
            </nav>
          

          

          

          
            <div class="links-of-author motion-element">
              
                <span class="links-of-author-item">
                  
                  
                    
                  
                  
                    
                  
                  <a href="https://github.com/fdsmlhn" title="GitHub &rarr; https://github.com/fdsmlhn" rel="noopener" target="_blank"><i class="fa fa-fw fa-github"></i>GitHub</a>
                </span>
              
                <span class="links-of-author-item">
                  
                  
                    
                  
                  
                    
                  
                  <a href="mailto:lihaonan@uw.edu" title="E-Mail &rarr; mailto:lihaonan@uw.edu" rel="noopener" target="_blank"><i class="fa fa-fw fa-envelope"></i>E-Mail</a>
                </span>
              
            </div>
          

          

          
          

          
            
          
          

        </div>
      </div>

      
      <!--noindex-->
        <div class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
            
            
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#background"><span class="nav-number">1.</span> <span class="nav-text">Background</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#some-complaints"><span class="nav-number">2.</span> <span class="nav-text">Some complaints</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#whats-exactly-in-this-blog"><span class="nav-number">3.</span> <span class="nav-text">What&#39;s exactly in this blog</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#who-should-read-this-blog"><span class="nav-number">4.</span> <span class="nav-text">Who should read this blog</span></a></li></ol><li class="nav-item nav-level-1"><a class="nav-link" href="#data-input-process"><span class="nav-number"></span> <span class="nav-text">data input process</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#tfrecord-saving-reading"><span class="nav-number">1.</span> <span class="nav-text">tfrecord saving, reading</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#experiment"><span class="nav-number">2.</span> <span class="nav-text">Experiment</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#tensorflow-lstm-cell"><span class="nav-number"></span> <span class="nav-text">Tensorflow LSTM CELL</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#single-cell-case"><span class="nav-number">1.</span> <span class="nav-text">Single cell case</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#multicell-case"><span class="nav-number">2.</span> <span class="nav-text">Multicell case</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#fast-predict"><span class="nav-number"></span> <span class="nav-text">fast predict</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#tensorflow-fast-predict"><span class="nav-number">1.</span> <span class="nav-text">tensorflow fast predict</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#tf.data.dataset.from_generator"><span class="nav-number">2.</span> <span class="nav-text">tf.data.Dataset().from_generator</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#test-shared-embedding"><span class="nav-number"></span> <span class="nav-text">test shared embedding</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#how-to-use-embedding"><span class="nav-number">0.1.</span> <span class="nav-text">1. How to use embedding</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#how-tf.varlen-react-when-read-in-batch"><span class="nav-number">0.2.</span> <span class="nav-text">2. How tf.Varlen react when read in batch</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#embedding-make_parse_example_spec"><span class="nav-number">0.3.</span> <span class="nav-text">embedding: make_parse_example_spec</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#check-tf.varlen"><span class="nav-number">1.</span> <span class="nav-text">check tf.varlen</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#check-naming-of-these-method"><span class="nav-number">2.</span> <span class="nav-text">check naming of these method</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#embedding---input_layer"><span class="nav-number">3.</span> <span class="nav-text">embedding - input_layer</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#miscellany"><span class="nav-number"></span> <span class="nav-text">Miscellany</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#tf.gather_nd"><span class="nav-number">1.</span> <span class="nav-text">tf.gather_nd</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#tf.less-tf.where"><span class="nav-number">2.</span> <span class="nav-text">tf.less + tf.where</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#tensor-computation"><span class="nav-number">3.</span> <span class="nav-text">Tensor computation</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#tensor-reshape"><span class="nav-number">4.</span> <span class="nav-text">Tensor reshape</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#import-.py-from-parent-directory"><span class="nav-number">5.</span> <span class="nav-text">import .py from parent directory</span></a></li></ol></li></div>
            

          </div>
        </div>
      <!--/noindex-->
      

      

    </div>
  </aside>
  


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; 2017 – <span itemprop="copyrightYear">2019</span>
  <span class="with-love" id="animate">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Haonan Li</span>

  

  
</div>


  <div class="powered-by">由 <a href="https://hexo.io" class="theme-link" rel="noopener" target="_blank">Hexo</a> 强力驱动 v3.8.0</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 – <a href="https://theme-next.org" class="theme-link" rel="noopener" target="_blank">NexT.Mist</a> v7.1.2</div>




        








        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

    

    
  </div>

  

<script>
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>


























  
  <script src="/lib/jquery/index.js?v=3.4.1"></script>

  
  <script src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>


  


  <script src="/js/utils.js?v=7.1.2"></script>

  <script src="/js/motion.js?v=7.1.2"></script>



  
  


  <script src="/js/schemes/muse.js?v=7.1.2"></script>




  
  <script src="/js/scrollspy.js?v=7.1.2"></script>
<script src="/js/post-details.js?v=7.1.2"></script>



  


  <script src="/js/next-boot.js?v=7.1.2"></script>


  

  

  

  
  
<script>
  function loadCount() {
    var d = document, s = d.createElement('script');
    s.src = 'https://haonanli.disqus.com/count.js';
    s.id = 'dsq-count-scr';
    (d.head || d.body).appendChild(s);
  }
  // defer loading until the whole page loading is completed
  window.addEventListener('load', loadCount, false);
</script>


<script>
  var disqus_config = function() {
    this.page.url = "http://fdsmlhn.github.io/2018/08/12/Advanced-Tensorflow-Usage-and-Experiment-from-input-fn-to-modelling-part/";
    this.page.identifier = "2018/08/12/Advanced-Tensorflow-Usage-and-Experiment-from-input-fn-to-modelling-part/";
    this.page.title = 'Advanced Tensorflow Usage and Experiment: from input_fn to modelling part';
    };
  function loadComments() {
    var d = document, s = d.createElement('script');
    s.src = 'https://haonanli.disqus.com/embed.js';
    s.setAttribute('data-timestamp', '' + +new Date());
    (d.head || d.body).appendChild(s);
  }
  
    window.addEventListener('load', loadComments, false);
  
</script>





  


  




  
  
  <script>
    
    function addCount(Counter) {
      var $visitors = $('.leancloud_visitors');
      var url = $visitors.attr('id').trim();
      var title = $visitors.attr('data-flag-title').trim();

      Counter('get', '/classes/Counter', { where: JSON.stringify({ url }) })
        .done(function({ results }) {
          if (results.length > 0) {
            var counter = results[0];
            
            Counter('put', '/classes/Counter/' + counter.objectId, JSON.stringify({ time: { '__op': 'Increment', 'amount': 1 } }))
            
              .done(function() {
                var $element = $(document.getElementById(url));
                $element.find('.leancloud-visitors-count').text(counter.time + 1);
              })
            
              .fail(function ({ responseJSON }) {
                console.log('Failed to save Visitor num, with error message: ' + responseJSON.error);
              })
          } else {
            
              Counter('post', '/classes/Counter', JSON.stringify({ title: title, url: url, time: 1 }))
                .done(function() {
                  var $element = $(document.getElementById(url));
                  $element.find('.leancloud-visitors-count').text(1);
                })
                .fail(function() {
                  console.log('Failed to create');
                });
            
          }
        })
        .fail(function ({ responseJSON }) {
          console.log('LeanCloud Counter Error: ' + responseJSON.code + ' ' + responseJSON.error);
        });
    }
    

    $(function() {
      $.get('https://app-router.leancloud.cn/2/route?appId=' + 'zbvuaBisX1AfjuwJMcWO9rzv-gzGzoHsz')
        .done(function({ api_server }) {
          var Counter = function(method, url, data) {
            return $.ajax({
              method: method,
              url: 'https://' + api_server + '/1.1' + url,
              headers: {
                'X-LC-Id': 'zbvuaBisX1AfjuwJMcWO9rzv-gzGzoHsz',
                'X-LC-Key': '3b93yKO3H6npVFDdtYKfwSYA',
                'Content-Type': 'application/json',
              },
              data: data
            });
          };
          
            addCount(Counter);
          
        });
    });
  </script>



  

  
  

  
  

  
    
      <script type="text/x-mathjax-config">
  

  MathJax.Hub.Config({
    tex2jax: {
      inlineMath: [ ['$', '$'], ['\\(', '\\)'] ],
      processEscapes: true,
      skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
    },
    TeX: {
      
      equationNumbers: {
        autoNumber: 'AMS'
      }
    }
  });
  MathJax.Hub.Register.StartupHook('TeX Jax Ready', function() {
    MathJax.InputJax.TeX.prefilterHooks.Add(function(data) {
      if (data.display) {
        var next = data.script.nextSibling;
        while (next && next.nodeName.toLowerCase() === '#text') { next = next.nextSibling }
        if (next && next.nodeName.toLowerCase() === 'br') { next.parentNode.removeChild(next) }
      }
    });
  });
</script>

<script type="text/x-mathjax-config">
  MathJax.Hub.Queue(function() {
    var all = MathJax.Hub.getAllJax(), i;
    for (i = 0; i < all.length; i += 1) {
      document.getElementById(all[i].inputID + '-Frame').parentNode.className += ' has-jax';
    }
  });
</script>
<script src="//cdn.staticfile.org/MathJax/MathJax-2.6-latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>

    
  


  

  

  

  

  

  

  

  

  
<script>
  $('.highlight').not('.gist .highlight').each(function(i, e) {
    var $wrap = $('<div>').addClass('highlight-wrap');
    $(e).after($wrap);
    $wrap.append($('<button>').addClass('copy-btn').append('复制').on('click', function(e) {
      var code = $(this).parent().find('.code').find('.line').map(function(i, e) {
        return $(e).text();
      }).toArray().join('\n');
      var ta = document.createElement('textarea');
      var yPosition = window.pageYOffset || document.documentElement.scrollTop;
      ta.style.top = yPosition + 'px'; // Prevent page scroll
      ta.style.position = 'absolute';
      ta.style.opacity = '0';
      ta.readOnly = true;
      ta.value = code;
      document.body.appendChild(ta);
      const selection = document.getSelection();
      const selected = selection.rangeCount > 0 ? selection.getRangeAt(0) : false;
      ta.select();
      ta.setSelectionRange(0, code.length);
      ta.readOnly = false;
      var result = document.execCommand('copy');
      
      ta.blur(); // For iOS
      $(this).blur();
      if (selected) {
        selection.removeAllRanges();
        selection.addRange(selected);
      }
    })).on('mouseleave', function(e) {
      var $b = $(this).find('.copy-btn');
      setTimeout(function() {
        $b.text('复制');
      }, 300);
    }).append(e);
  })
</script><!-- hexo-inject:begin --><!-- Begin: Injected MathJax -->
<script type="text/x-mathjax-config">
  MathJax.Hub.Config("");
</script>

<script type="text/x-mathjax-config">
  MathJax.Hub.Queue(function() {
    var all = MathJax.Hub.getAllJax(), i;
    for(i=0; i < all.length; i += 1) {
      all[i].SourceElement().parentNode.className += ' has-jax';
    }
  });
</script>

<script type="text/javascript" src>
</script>
<!-- End: Injected MathJax -->
<!-- hexo-inject:end -->


  

  

</body>
</html>
